<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>rocketmq consumer优雅停机的探索 | Wen Er Rd. NO. 48</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">rocketmq consumer优雅停机的探索</h1><a id="logo" href="/.">Wen Er Rd. NO. 48</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Start</i></a><a href="/archives/"><i class="fa fa-archive"> Archiv</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">rocketmq consumer优雅停机的探索</h1><div class="post-meta">Dec 20, 2018</div><div class="post-content"><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>最近在项目（一个dubbo服务）发布的时候经常报这个错<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nested exception is org.apache.ibatis.exceptions.PersistenceException: ### Error querying database. Cause: org.springframework.jdbc.CannotGetJdbcConnectionException: Could not get JDBC Connection; nested exception is com.alibaba.druid.pool.DataSourceClosedException: dataSource already closed</div></pre></td></tr></table></figure></p>
<p>简单看来是数据库连接已经关闭了，但还在执行逻辑。很奇怪，发布时，dubbo是会先被从zk中摘除掉，再停止服务，按道理说是不会有这种错报出来，接着看调用栈发现是rocketmq consumer中报出来的，原来rocketmq consumer线程一直在跑，并没有停止，所以在spring容器关闭的时候，还在执行的逻辑会报错。<br>其中consumer启动代码大致如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">public void init() throws MQClientException &#123;</div><div class="line">    consumer = new DefaultMQPushConsumer(groupName);</div><div class="line">    consumer.setNamesrvAddr(namesrvAddr);  consumer.subscribe(topic, tag);</div><div class="line">    consumer.setConsumeMessageBatchMaxSize(getConsumeMessageBatchMaxSize());</div><div class="line">    consumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_LAST_OFFSET);</div><div class="line">    consumer.setMessageModel(MessageModel.CLUSTERING);</div><div class="line">    consumer.registerMessageListener(new MsgListener());</div><div class="line">    if (getInstanceName() != null) &#123;</div><div class="line">        consumer.setInstanceName(getInstanceName());</div><div class="line">    &#125;</div><div class="line">    consumer.start();</div><div class="line"></div><div class="line">    Thread shutdownThread = new Thread(new Runnable() &#123;</div><div class="line">        public void run() &#123;</div><div class="line">            if (consumer != null) &#123;</div><div class="line">                consumer.shutdown();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;, this.getClass().getName() + &quot;MsgListener&quot;);</div><div class="line">    shutdownThread.setPriority(Thread.MAX_PRIORITY);</div><div class="line">&#125;</div><div class="line"></div><div class="line">...</div><div class="line">public void destroy() &#123;</div><div class="line">    if (consumer != null) &#123;</div><div class="line">        consumer.shutdown();</div><div class="line">    &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>虽然注册了一个shutdown的hook，而且设置了最高优先级，但从实际中看来是没有达到预期的效果的。<br>查了资料，有这么一段描述：</p>
<blockquote>
<ul>
<li>Thread.setPriority()可能根本不做任何事情，这跟你的操作系统和虚拟机版本有关</li>
<li>线程优先级对于不同的线程调度器可能有不同的含义，可能并不是你直观的推测。特别地，优先级并不一定是指CPU的分享。在UNIX系统，优先级或多或少可以认为是CPU的分配，但Windows不是这样</li>
<li>线程的优先级通常是全局的和局部的优先级设定的组合。Java的setPriority()方法只应用于局部的优先级。换句话说，你不能在整个可能的范围 内设定优先级。（这通常是一种保护的方式，你大概不希望鼠标指针的线程或者处理音频数据的线程被其它随机的用户线程所抢占）</li>
<li>不同的系统有不同的线程优先级的取值范围，但是Java定义了10个级别（1-10）。这样就有可能出现几个线程在一个操作系统里有不同的优先级，在另外一个操作系统里却有相同的优先级（并因此可能有意想不到的行为）</li>
<li>操作系统可能（并通常这么做）根据线程的优先级给线程添加一些专有的行为（例如”only give a quantum boost if the priority is below X“）。这里再重复一次，优先级的定义有部分在不同系统间有差别。</li>
<li>大多数操作系统的线程调度器实际上执行的是在战略的角度上对线程的优先级做临时操作（例如当一个线程接收到它所等待的一个事件或者I/O），通常操作系统知道最多，试图手工控制优先级可能只会干扰这个系统。</li>
<li>你的应用程序通常不知道有哪些其它进程运行的线程，所以对于整个系统来说，变更一个线程的优先级所带来的影响是难于预测的。例如你可能发现，你有一个预期 为偶尔在后台运行的低优先级的线程几乎没有运行，原因是一个病毒监控程序在一个稍微高一点的优先级（但仍然低于普通的优先级）上运行，并且无法预计你程序 的性能，它会根据你的客户使用的防病毒程序不同而不同。</li>
</ul>
</blockquote>
<p>总结一句话就是优先级高的在全局范围内不一定会优先执行。</p>
<p>注册的spring bean 的destroy执行顺序也有问题，他不一定是在db connect关闭前执行，也就是说两个bean的销毁并没有先后顺序，这点看下面的分析。</p>
<h3 id="spring依赖调整尝试"><a href="#spring依赖调整尝试" class="headerlink" title="spring依赖调整尝试"></a>spring依赖调整尝试</h3><p>由于整个项目是基于spring容器管理的，所以第一想到的是调整spring销毁bean的顺序，如果最先销毁consumer这个bean问题就解决了。我们看下面这个例子，有两个bean，A和B，A依赖B<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</div><div class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</div><div class="line">       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</div><div class="line">       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;</div><div class="line"></div><div class="line">    &lt;bean id=&quot;a&quot; class=&quot;depend.A&quot; init-method=&quot;init&quot; destroy-method=&quot;destroy&quot; &gt;</div><div class="line">    &lt;/bean&gt;</div><div class="line">    &lt;bean id=&quot;b&quot; class=&quot;depend.B&quot; init-method=&quot;init&quot; destroy-method=&quot;destroy&quot;&gt;</div><div class="line">    &lt;/bean&gt;</div><div class="line">&lt;/beans&gt;</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">package depend;</div><div class="line"></div><div class="line">import javax.annotation.Resource;</div><div class="line"></div><div class="line">public class A &#123;</div><div class="line"></div><div class="line">    @Resource</div><div class="line">    private B b;</div><div class="line"></div><div class="line">    public B getB() &#123;</div><div class="line">        return b;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setB(B b) &#123;</div><div class="line">        this.b = b;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void init() &#123;</div><div class="line">        System.out.println(&quot;A init&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void destroy() &#123;</div><div class="line">        System.out.println(&quot;A destroy&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void doSomething() &#123;</div><div class="line">        System.out.println(&quot;A doSomething&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">package depend;</div><div class="line"></div><div class="line">public class B &#123;</div><div class="line"></div><div class="line">    public void init() &#123;</div><div class="line">        System.out.println(&quot;B init&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void destroy() &#123;</div><div class="line">        System.out.println(&quot;B destroy&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void doSomething() &#123;</div><div class="line">        System.out.println(&quot;B doSomething&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">package main;</div><div class="line"></div><div class="line">import depend.A;</div><div class="line">import org.springframework.context.support.ClassPathXmlApplicationContext;</div><div class="line"></div><div class="line">public class DependMain &#123;</div><div class="line"></div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        ClassPathXmlApplicationContext context = new ClassPathXmlApplicationContext(&quot;Depend.xml&quot;);</div><div class="line">        A a = (A) context.getBean(&quot;a&quot;);</div><div class="line">        a.doSomething();</div><div class="line">        context.registerShutdownHook();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>项目中也是用@Resource来注入依赖的，我们执行一下main发现可能会有如下的输出:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">A init</div><div class="line">B init</div><div class="line">A doSomething</div><div class="line">B destroy</div><div class="line">A destroy</div></pre></td></tr></table></figure></p>
<p>说明A在初始化时并没有在B之后，而且A也是在B销毁后才销毁的，说明了@Resource并没有处理依赖关系。<br>稍微修改一下xml配置文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</div><div class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</div><div class="line">       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</div><div class="line">       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;</div><div class="line"></div><div class="line">    &lt;bean id=&quot;a&quot; class=&quot;depend.A&quot; init-method=&quot;init&quot; destroy-method=&quot;destroy&quot; depends-on=&quot;b&quot;&gt;</div><div class="line">    &lt;/bean&gt;</div><div class="line">    &lt;bean id=&quot;b&quot; class=&quot;depend.B&quot; init-method=&quot;init&quot; destroy-method=&quot;destroy&quot;&gt;</div><div class="line">    &lt;/bean&gt;</div><div class="line">&lt;/beans&gt;</div></pre></td></tr></table></figure></p>
<p>加一个depend-on，发现输出是这样的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">B init</div><div class="line">A init</div><div class="line">A doSomething</div><div class="line">A destroy</div><div class="line">B destroy</div></pre></td></tr></table></figure></p>
<p>说明依赖生效了，同时我发现这样写也是可以处理依赖关系的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</div><div class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</div><div class="line">       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</div><div class="line">       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;</div><div class="line"></div><div class="line">    &lt;bean id=&quot;a&quot; class=&quot;depend.A&quot; init-method=&quot;init&quot; destroy-method=&quot;destroy&quot;&gt;</div><div class="line">        &lt;property name=&quot;b&quot; ref=&quot;b&quot;/&gt;</div><div class="line">    &lt;/bean&gt;</div><div class="line">    &lt;bean id=&quot;b&quot; class=&quot;depend.B&quot; init-method=&quot;init&quot; destroy-method=&quot;destroy&quot;&gt;</div><div class="line">    &lt;/bean&gt;</div><div class="line">&lt;/beans&gt;</div></pre></td></tr></table></figure></p>
<p>这也解释了为什么只有Dao调用db connect时报错，Dao就是用property依赖db connect的，Spring在关闭时一定是先关闭db connect，再关闭Dao，而Spring的bean在还有引用的时候是不会被回收的，所以只有db connect断开连接会报错。</p>
<p>拿到业务上来说，mq consumer依赖biz1Service，biz1Service依赖biz2Service,biz2Service依赖Dao，Dao依赖db connect，这要是梳理出这个depend-on实在是有点麻烦，于是放弃了这个想法。</p>
<h3 id="设置环境变量尝试"><a href="#设置环境变量尝试" class="headerlink" title="设置环境变量尝试"></a>设置环境变量尝试</h3><p>找公司的java大神问了一下，他给出了一个建议是在应用启动时设置一个环境变量，假设叫MQ_RUN=1，当rocketmq消费消息时读取该变量，判断是MQ_RUN==1，成立则继续执行，否则<br>return ConsumeConcurrentlyStatus.RECONSUME_LATER，保证消息不丢失，当应用关闭时设置这个环境变量为MQ_RUN=0，sleep个几秒钟，再去真正关闭应用。思路大致是有了，试一下发现环境变量不是这么好设置的，因为export MQ_RUN=1定义的变量，会对自己所在的shell进程及其子进程生效，启动时好说，应用是启动脚本的子进程，MQ_RUN=1设置没问题，停止时，停止脚本是发一个信号给应用，这两个进程没有关系，设置MQ_RUN=0也就无效了。</p>
<h3 id="信号尝试"><a href="#信号尝试" class="headerlink" title="信号尝试"></a>信号尝试</h3><p>由于上面的铺垫，想到了使用类似健康检查的方式来停止consumer的消费，写一个接口来设置这个环境变量，关闭应用脚本时执行一下，但是这样做会有风险，接口是对外暴露的，任何人都可以请求这个接口来关闭consumer的消费。于是又想到了信号，参考我之前的文章<a href="https://lkxiaolou.github.io/2017/03/23/kill-your-process/" target="_blank" rel="external">《如何正确地杀死你的进程》</a>，在应用中监听一个信号，应用关闭脚本中先向应用发送一个信号，kill -x $pid，应用中监听这个信号设置MQ_RUN=0，让消费停止，再去关闭应用即可。</p>
<h3 id="最后说一句"><a href="#最后说一句" class="headerlink" title="最后说一句"></a>最后说一句</h3><p>其实这个报错对线上一点都不影响，rocketmq采取的是消费ack的方式来确定消息是否消费，当报错时消息又会被塞回broker，下次会继续消费，但这个问题也是有点意思，所以记录下来，最后的解决方式我觉得还是不是很优雅，目前能想到的也只有这样，我希望的是spring能有一种严格的依赖关系，并且不需要逐个设置，只需要打开全局配置即可。</p>
</div><div class="tags"><a href="/tags/java/">java</a></div><div class="post-nav"><a class="next" href="/2018/09/03/HashMap的resize详解/">HashMap的resize详解</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Kategorien</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/学习笔记/" style="font-size: 15px;">学习笔记</a> <a href="/tags/源码/" style="font-size: 15px;">源码</a> <a href="/tags/小玩意/" style="font-size: 15px;">小玩意</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Letzte</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/12/20/rocketmq-consumer-shutdown/">rocketmq consumer优雅停机的探索</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/03/HashMap的resize详解/">HashMap的resize详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/13/浅析ConcurrentHashMap/">浅析ConcurrentHashMap</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/11/从单例模式到序列化/">从单例模式到序列化</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/10/synchronized的用法/">synchronized的用法</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/09/从ThreadLocal到AtomicXXX再到Unsafe/">从ThreadLocal到AtomicXXX再到Unsafe</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/08/java并发包工具之CountDownLatch-CyclicBarrier-Semaphore/">java并发包工具之CountDownLatch/CyclicBarrier/Semaphore</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/07/spring-aop之aspectj的使用教程/">spring aop之aspectj的使用教程</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/06/Java反射机制学习笔记/">Java反射机制学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/05/java注解学习笔记/">java注解学习笔记</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Blogroll</i></div><ul></ul><a href="http://wismartzy.github.io/" title="wismartzy" target="_blank">wismartzy</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">Wen Er Rd. NO. 48.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>